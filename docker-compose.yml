services:
  app:
    image: markoshust/magento-nginx:1.24-0
    container_name: magento-app
    ports:
      - "8096:8000"
      - "8443:8443"
    volumes:
      - ./pub:/var/www/html/pub
      - ./var:/var/www/html/var
      - ./:/var/www/html:cached
      - ./generated:/var/www/html/generated
      - ./media:/var/www/html/media

      # nginx override
      - ./bin/docker/images/default/nginx.conf.override:/etc/nginx/conf.d/default.conf

      # sockets / certs
      - sockdata:/sock
      - ssldata:/etc/nginx/certs
    depends_on:
      - phpfpm
      - db
      - opensearch
      - mailcatcher

  phpfpm:
    environment:
      HOST_UID: "1000"
      HOST_GID: "1000"
    build:
      context: .
      dockerfile: ./bin/docker/images/default/Dockerfile
    container_name: magento-phpfpm
    volumes:
      - ~/.ssh/id_rsa:/var/www/.ssh/id_rsa:cached
      - ~/.ssh/known_hosts:/var/www/.ssh/known_hosts:cached

      - ./Api:/var/www/html/app/code/HiPay/FullserviceMagento/Api
      - ./Block:/var/www/html/app/code/HiPay/FullserviceMagento/Block
      - ./Controller:/var/www/html/app/code/HiPay/FullserviceMagento/Controller
      - ./etc:/var/www/html/app/code/HiPay/FullserviceMagento/etc
      - ./Helper:/var/www/html/app/code/HiPay/FullserviceMagento/Helper
      - ./Model:/var/www/html/app/code/HiPay/FullserviceMagento/Model
      - ./Console:/var/www/html/app/code/HiPay/FullserviceMagento/Console
      - ./Observer:/var/www/html/app/code/HiPay/FullserviceMagento/Observer
      - ./Plugin:/var/www/html/app/code/HiPay/FullserviceMagento/Plugin
      - ./Ui:/var/www/html/app/code/HiPay/FullserviceMagento/Ui
      - ./view:/var/www/html/app/code/HiPay/FullserviceMagento/view
      - ./Setup:/var/www/html/app/code/HiPay/FullserviceMagento/Setup
      - ./Cron:/var/www/html/app/code/HiPay/FullserviceMagento/Cron
      - ./i18n:/var/www/html/app/code/HiPay/FullserviceMagento/i18n
      - ./Logger:/var/www/html/app/code/HiPay/FullserviceMagento/Logger
      - ./tests:/var/www/html/app/code/HiPay/FullserviceMagento/tests
      - ./composer.json:/var/www/html/app/code/HiPay/FullserviceMagento/composer.json
      - ./registration.php:/var/www/html/app/code/HiPay/FullserviceMagento/registration.php

      # Magento runtime files
      - ./pub:/var/www/html/pub
      - ./var:/var/www/html/var
      - ./generated:/var/www/html/generated
      - ./media:/var/www/html/media
    env_file:
      - ./bin/docker/conf/development/auth.env
      - ./bin/docker/conf/development/hipay.env
      - ./bin/docker/conf/development/mage.env
      - ./bin/docker/conf/development/module.env

  db:
    image: mariadb:11.4
    container_name: magento-db
    command:
      --max_allowed_packet=64M
      --optimizer_use_condition_selectivity=1
      --optimizer_switch="rowid_filter=off"
      --log_bin_trust_function_creators=1
    ports:
      - "3308:3306"
    environment:
      MARIADB_ROOT_PASSWORD: root
      MARIADB_DATABASE: magento
      MARIADB_USER: magento
      MARIADB_PASSWORD: magento
    volumes:
      - dbdata:/var/lib/mysql

  opensearch:
    image: markoshust/magento-opensearch:2.5-1
    platform: linux/amd64
    container_name: magento-opensearch
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - "discovery.type=single-node"
      - "cluster.routing.allocation.disk.threshold_enabled=false"
      - "OPENSEARCH_INITIAL_ADMIN_PASSWORD=Hg7$9LpQz@32"
      - "OPENSEARCH_JAVA_OPTS=-Xms768m -Xmx768m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=1s | grep -q '\"status\"'" ]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 30s
    volumes:
      - opensearchdata:/usr/share/opensearch/data
      - ./bin/docker/images/default/opensearch.yml:/usr/share/opensearch/config/opensearch.yml:ro

  mailcatcher:
    image: sj26/mailcatcher:v0.10.0
    container_name: magento-mailcatcher
    ports:
      - "1016:1080"

volumes:
  dbdata:
  opensearchdata:
  sockdata:
  ssldata:
