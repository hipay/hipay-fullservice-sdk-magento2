FROM bitnami/magento:2.4.5

RUN apt-get update && apt-get upgrade -y && apt-get install -y curl git unzip

RUN curl -O  https://files.magerun.net/n98-magerun2.phar  \
    && chmod +x ./n98-magerun2.phar \
    && cp ./n98-magerun2.phar /usr/local/bin/ \
    && rm ./n98-magerun2.phar

RUN echo 'Mutex posixsem' >>/opt/bitnami/apache2/conf/httpd.conf
COPY ./bin/docker/images/default/php-override.ini /opt/bitnami/php/etc/conf.d/php-override.ini

#====================================================
# OVERRIDE PARENT ENTRYPOINT
#=====================================================

ENV DIRPATH=/bitnami/magento

RUN echo "is_app_initialized() { false; }" >> /opt/bitnami/scripts/libpersistence.sh

COPY ./bin/docker/conf/development/auth.json /usr/sbin/.composer/auth.json

COPY ./bin/docker/images/default/entrypoint_helm.sh /usr/local/bin/
RUN  chmod u+x /usr/local/bin/entrypoint_helm.sh

ENTRYPOINT ["/usr/local/bin/entrypoint_helm.sh"]
CMD [ "/opt/bitnami/scripts/magento/run.sh" ]
